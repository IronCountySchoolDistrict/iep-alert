<!-- This page contains the logic and markup to display the IEP Alert icon on both PS Teacher and PS Admin pages. -->
<!-- Begin IEP Alert (7.9) content -->
<script type="text/template" id="alert-template">
    <!-- Custom alert begin -->
    <%
    // If the user is on the admin side of PS, use the admin url for the alert dialogcontent attr.
    // If not, use the teachers url for the alert.
    if (window.location.href.indexOf('admin') != -1) {
    %>
    <a class="dialogM" title="IEP Alert" id="iep-alert" href title='Student Services Alert'
       dialogcontent="/admin/alerts/iepalert.html?frn=~(studentfrn)">
        <%
        } else {
        %>
        <a class="dialogM" title="IEP Alert" id="iep-alert" href title='Student Services Alert'
           dialogcontent="/teachers/alerts/iepalert.html?frn=~(studentfrn)">
            <%
            }
            %>
            <img id='alert-img' style="display:none"
                 src="/images/icon-i.png"
                 height="20" width="19"
                 alt="Student Services Alert" border="0">
        </a>
        <!-- Custom alert end -->
</script>

<script type="text/javascript">
    require(['underscore'], function () {
        'use strict';
        if (psData === undefined) {
            var psData = {};
        }
        psData.studentfrn = "~(studentfrn)";
        $j.getJSON('/admin/json/alert.json.html?frn=' + psData.studentfrn, function (alert) {
            var alertTemplate = $j('#alert-template').html();
            var renderedTemplate = _.template(alertTemplate, {});
            var pageHeader = $j('h1');
            var alerts = pageHeader.find('.dialogM');
            // If there are alerts already displayed
            if ( !($j.isEmptyObject(alerts[0])) ) {
                var select = alerts.last();
                $j(renderedTemplate).insertAfter(select);
            } else {
                var select = pageHeader.contents().eq(0);
                $j(renderedTemplate).insertAfter(select);
            }

            if (alert.caseload !== ' ') {
                $j('#alert-img').css({'display': 'inline'});
            }

            // TODO: Refactor this so this code doesn't have to run again after the alert is added.
            alerts = pageHeader.find('.dialogM');

            // Find the span element that contains elements with class .dialogM (alerts),
            // and remove "float: right" css rule from that span.
            // Note that not all pages with alerts place alerts in a span tag.
            var spanAlerts = pageHeader.find('span .dialogM');
            if ( !($j.isEmptyObject(spanAlerts)[0]) ) {
                var alertSpan = spanAlerts.eq(0).parent();
                if (alertSpan.css('float') == 'right') {
                    alertSpan.css('float', 'none');
                }
            }

            $j.each(alerts, function(index, elem) {
                $j(elem).css({'visibility': 'visible'});
            });

            $j('#student-service-alert').on('click', function(event) {
                var template = $j('#alert-balance~(studentfrn)').html();
                var renderedTemplate = _.template(template, {});
                $j('#psDialog').html(renderedTemplate);
            });
        });


    });
</script>
<!-- End IEP Alert (7.9) content -->